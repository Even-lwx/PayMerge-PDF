# 该脚本原创作者为ZhangStudyLife，我仅在其基础上做了优化

# 发票合并脚本 - 智能自适应版本 v2.0

本工具在当前目录下生成 `已合并` 文件夹，并把成套的发票与记录合并为 单页 PDF：

## 🚀 智能自适应布局 v2.0

**🆕 新增旋转优化功能：**
- 🔄 **智能旋转检测**：自动测试每张图片旋转90度后的效果
- 📐 **8种组合评估**：测试3张图片的所有旋转组合（2³=8种可能）
- 🎯 **最优方案选择**：自动选择空间利用率最高的旋转+布局组合
- 💫 **无缝旋转**：自动应用最佳旋转角度，无需手动干预

**核心智能特性：**
- 🧠 **智能布局选择**：根据发票、购买记录、支付记录三张图片的实际尺寸和比例，自动选择最优布局
- 📊 **动态空间分配**：不再固定分配上下或左右空间，而是根据内容比例动态调整
- 🔄 **双重布局算法**：
  - **水平布局**：发票占上部，两张记录图根据比例分配下部空间
  - **垂直布局**：发票占左侧，两张记录图纵向排列占右侧
- 📏 **最大化空间利用**：通过计算每种布局+旋转组合的空间利用率，自动选择最佳方案

## 📐 布局规则

- **A4 纵向、白底、15mm 边距**
- **智能尺寸适配**：
  - 所有图片等比缩放，确保不变形
  - 根据图片原始比例优化显示效果
  - 自动在两种布局方案中选择空间利用率更高的方案
- **间距优化**：图片间保持 5mm 间距，确保视觉清晰

## 🔤 命名匹配

- 源文件：`[编号+名称+价格].pdf`（示例：`1开发板19.9.pdf`）
- 购买记录：`[相同前缀]购买记录.(jpg|jpeg|png)`
- 支付记录：`[相同前缀]支付记录.(jpg|jpeg|png)`
- 输出：`已合并/[相同前缀]已合并.pdf`

若三者不齐全，则跳过。若输出已存在，也跳过（不会覆盖）。不会修改任何源文件。

## 环境准备（Windows PowerShell）

建议使用 Python 3.9+。

```powershell
# 进入此目录后安装依赖
pip install -r requirements.txt

# 运行脚本（会在本目录创建“已合并”文件夹）
python .\merge_invoices.py
```

## 常见问题

- 输出 PDF 为一页：脚本取源 PDF 的第一页并与两张记录图排在一页内。
- 图片方向/大小：会等比缩放放入各自半页区域，不会拉伸变形。
- 编码问题：文件名为中文时，一般无需特别设置；若报错，确保系统编码与 Python 环境支持 UTF-8。
